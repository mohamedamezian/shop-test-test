{% comment %} Instagram Feed {% endcomment %}

{% assign posts_limit = block.settings.posts_limit | default: 12 %}

{%- comment -%}
  Fetch the instagram-list metaobject (handle: instagram-feed-list)
  and loop through its posts field (list of post metaobject references)
{%- endcomment -%}

{% assign instagram_list = null %}
{% for list in metaobjects['instagram-list'].values %}
  {% if list.handle == 'instagram-feed-list' or list.system.handle == 'instagram-feed-list' %}
    {% assign instagram_list = list %}
    {% break %}
  {% endif %}
{% endfor %}

{% if instagram_list and instagram_list.posts %}
  {% assign post_references = instagram_list.posts.value %}

  {% if post_references.size > 0 %}
    <div class="instagram-feed">
      {% for post in post_references limit: posts_limit %}
        {% assign post_data_json = post.data.value %}
        {% assign permalink_start = post_data_json | split: '"permalink":"' %}
        {% if permalink_start.size > 1 %}
          {% assign permalink_parts = permalink_start[1] | split: '"' %}
          {% assign post_permalink = permalink_parts[0] %}
        {% else %}
          {% assign post_permalink = '' %}
        {% endif %}

        <article class="instagram-post card-media-only">
          <a href="{{ post_permalink }}" target="_blank" rel="noopener noreferrer" class="card-link">
            <div class="card-media-wrapper">
              {% for media in post.images.value limit: 1 %}
                {% if media.sources %}
                  <video class="card-media video" width="1000" height="1000" loop muted playsinline autoplay>
                    {% for source in media.sources %}
                      {%- comment -%} external media served from Shopify CDN / remote URL; asset_url not applicable {%- endcomment -%}
                      <source data-src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endfor %}
                  </video>
                {% else %}
                  <img
                    class="card-media img"
                    src="{{ media | image_url: width: 1000 }}"
                    alt="{{ post.caption.value }}"
                    loading="lazy"
                    width="1000"
                    height="1000"
                  >
                {% endif %}
              {% endfor %}

              <!-- Overlay (appears on hover) -->
              <div class="card-overlay">
                <div class="overlay-top-left">
                  <div class="profile-pic small">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                  </div>
                  <div class="names vertical">
                    <span class="name">{{ instagram_list.name }}</span>
                    <span class="username">{{ instagram_list.username }}</span>
                  </div>
                </div>

                <button class="overlay-center-btn" data-video-target>
                  <!-- icon replaced by JS based on media type -->
                  <svg
                    class="instagram-center-icon"
                    width="40"
                    height="40"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="white"
                    stroke-width="1.6"
                  >
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                  </svg>
                  <svg
                    class="play-center-icon"
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="white"
                    style="display:none;"
                  >
                    <path d="M5 3v18l15-9z"/>
                  </svg>
                  <svg
                    class="pause-center-icon"
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="white"
                    style="display:none;"
                  >
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                  </svg>
                </button>

                <div class="overlay-bottom">
                  <div class="stats">
                    <span class="likes">‚ù§Ô∏è {{ post.likes.value | default: 0 }}</span>
                    <span class="comments">üí¨ {{ post.comments.value | default: 0 }}</span>
                  </div>
                  <div class="caption-row">
                    <div class="caption-text">{{ post.caption.value }}</div>
                    {% for media in post.images.value limit: 1 %}
                      {% if media.sources %}
                        <button class="mute-btn" aria-label="Toggle mute">üîà</button>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </a>
        </article>
      {% endfor %}
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="share-modal" style="display:none;">
      <div class="share-modal-content">
        <div class="share-modal-header">
          <h3>Share Post</h3>
          <button class="share-modal-close">&times;</button>
        </div>
        <div class="share-modal-body">
          <input type="text" id="share-link" readonly class="share-link-input">
          <button class="copy-link-btn">Copy Link</button>
        </div>
        <div class="copy-feedback" style="display:none;">‚úì Link copied!</div>
      </div>
    </div>

    <script>
      // Share functionality
      document.querySelectorAll('.share-btn').forEach((btn) => {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          const permalink = this.dataset.permalink;
          const modal = document.getElementById('share-modal');
          const input = document.getElementById('share-link');
          input.value = permalink;
          modal.style.display = 'flex';

          // Auto-select the text after a short delay to ensure modal is visible
          setTimeout(() => {
            input.select();
            input.focus();
          }, 100);
        });
      });

      // Close modal
      document.querySelector('.share-modal-close').addEventListener('click', function () {
        document.getElementById('share-modal').style.display = 'none';
      });

      // Close on backdrop click
      document.getElementById('share-modal').addEventListener('click', function (e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });

      // Copy link
      document.querySelector('.copy-link-btn').addEventListener('click', function () {
        const input = document.getElementById('share-link');
        input.select();
        input.focus();

        // Use modern clipboard API if available, fallback to execCommand
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(input.value)
            .then(() => {
              showCopyFeedback();
            })
            .catch(() => {
              // Fallback to execCommand
              document.execCommand('copy');
              showCopyFeedback();
            });
        } else {
          document.execCommand('copy');
          showCopyFeedback();
        }
      });

      function showCopyFeedback() {
        const feedback = document.querySelector('.copy-feedback');
        feedback.style.display = 'block';
        setTimeout(() => {
          feedback.style.display = 'none';
          document.getElementById('share-modal').style.display = 'none';
        }, 1500);
      }

      // Video play on media click (not on link click)
      document.querySelectorAll('.post-media video').forEach((video) => {
        video.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.paused ? this.play() : this.pause();
        });
      });
    </script>
    <script>
      // Populate video sources from data-src to avoid theme-check asset_url warnings
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('video').forEach(function (video) {
          var updated = false;
          video.querySelectorAll('source').forEach(function (src) {
            var data = src.getAttribute('data-src');
            if (data) {
              src.src = data;
              updated = true;
            }
          });
          if (updated) {
            try {
              video.load();
            } catch (e) {}
          }
        });
      });
    </script>
  {% else %}
    <div
      class="instagram-feed-empty"
      style="padding:1rem;background:#fff;border:1px dashed #ddd;border-radius:8px;text-align:center;color:#666;"
    >
      <p style="margin:0">
        No Instagram posts found in the list. Sync your Instagram posts or add them to the
        <code>instagram-list</code> metaobject.
      </p>
    </div>
  {% endif %}
{% else %}
  <div
    class="instagram-feed-empty"
    style="padding:1rem;background:#fff;border:1px dashed #ddd;border-radius:8px;text-align:center;color:#666;"
  >
    <p style="margin:0">
      Instagram feed not configured. Create an <code>instagram-list</code> metaobject with handle
      <code>instagram-feed-list</code> or connect the Instagram app.
    </p>
  </div>
{% endif %}

<style>
  /* Container */
  .instagram-feed {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
  }
  /* Card is just the media */
  .instagram-post.card-media-only {
    background: transparent;
    border: none;
    border-radius: 8px;
    overflow: hidden;
  }

  .card-media-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* square */
    overflow: hidden;
  }

  .card-media {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* small profile in top-left, names vertical and centered to pic */
  .overlay-top-left {
    position: absolute;
    top: 8px;
    left: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 3;
  }

  .profile-pic.small {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    padding: 2px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .names.vertical {
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1;
  }

  .names .name {
    font-weight: 600;
    font-size: 13px;
    color: #fff;
  }
  .names .username {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.85);
  }

  /* Overlay that appears on hover */
  .card-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    opacity: 0;
    transition: opacity 0.18s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 2;
  }

  .card-media-wrapper:hover .card-overlay {
    opacity: 1;
  }

  .overlay-center-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.45);
    border: none;
    border-radius: 999px;
    padding: 8px 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 4;
    cursor: pointer;
  }

  .overlay-center-btn svg {
    display: block;
  }

  .overlay-bottom {
    padding: 10px;
    display: flex;
    bottom: 0;
    flex-direction: column;
    gap: 6px;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
    color: #fff;
    z-index: 4;
  }

  .stats {
    display: flex;
    gap: 12px;
    align-items: center;
    font-weight: 600;
  }
  .caption-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .caption-text {
    font-size: 13px;
    color: #fff;
    max-width: 85%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .mute-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }

  @media (max-width: 600px) {
    .overlay-top-left {
      top: 6px;
      left: 6px;
    }
  }
</style>

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "settings": [
    {
      "type": "range",
      "id": "posts_limit",
      "label": "Number of posts",
      "min": 4,
      "max": 24,
      "step": 1,
      "default": 12
    }
  ]
}
{% endschema %}
